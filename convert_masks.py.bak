import os
import numpy as np
from PIL import Image
from tqdm import tqdm

# --- Config ---
# Source folders (where your current data is)
SRC_TRAIN_DIR = 'data/VOCdevkit/VOC2012/SegmentationClassAug'
SRC_VAL_DIR = 'data/VOCdevkit/VOC2012/SegmentationClass'

# Destination folders (where we will create the new 4-class masks)
DST_TRAIN_DIR = 'data/VOCdevkit/VOC2012/SegmentationClass4Class_Train'
DST_VAL_DIR = 'data/VOCdevkit/VOC2012/SegmentationClass4Class_Val'

# The lists of files we care about (generated in the previous step)
TRAIN_LIST = 'data/VOCdevkit/VOC2012/ImageSets/Segmentation/train_3class.txt'
VAL_LIST = 'data/VOCdevkit/VOC2012/ImageSets/Segmentation/val_3class.txt'

# The Magic Mapping
# Key = Original PASCAL ID, Value = New ID
MAPPING = {
    0: 0,   # Background -> Background
    15: 1,  # Person -> Class 1
    9: 2,   # Chair -> Class 2
    11: 3   # Diningtable -> Class 3
    # All others will default to 255 (Ignore)
}

def convert_folder(list_file, src_dir, dst_dir):
    print(f"Processing {list_file}...")
    if not os.path.exists(dst_dir):
        os.makedirs(dst_dir)

    # Read the list of files to convert
    with open(list_file, 'r') as f:
        file_names = [x.strip() for x in f.readlines()]

    for name in tqdm(file_names):
        src_path = os.path.join(src_dir, name + '.png')
        dst_path = os.path.join(dst_dir, name + '.png')

        # 1. Load Mask
        try:
            mask = Image.open(src_path)
            mask_arr = np.array(mask)
        except FileNotFoundError:
            continue # Skip missing files

        # 2. Create New Mask (filled with 255/Ignore)
        new_mask = np.full_like(mask_arr, 255)

        # 3. Apply Mapping
        for old_id, new_id in MAPPING.items():
            new_mask[mask_arr == old_id] = new_id

        # 4. Save
        new_img = Image.fromarray(new_mask.astype(np.uint8), mode='P')
        # Copy palette from original so colors roughly match (optional but nice)
        if mask.mode == 'P':
            new_img.putpalette(mask.getpalette())
        
        new_img.save(dst_path)

if __name__ == '__main__':
    convert_folder(TRAIN_LIST, SRC_TRAIN_DIR, DST_TRAIN_DIR)
    convert_folder(VAL_LIST, SRC_VAL_DIR, DST_VAL_DIR)
    print("Conversion Complete!")
